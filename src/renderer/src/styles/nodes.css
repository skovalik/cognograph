/* =============================================================================
   THEME CSS VARIABLES
   ============================================================================= */

:root {
  /* === ALIASES: Node variables now reference tokens === */
  --node-bg: var(--surface-node);
  --node-bg-secondary: var(--surface-node-secondary);
  --node-border-secondary: var(--border-node);
  --node-text-primary: var(--text-primary);
  --node-text-secondary: var(--text-secondary);
  --node-text-muted: var(--text-muted);
  --node-header-bg: var(--surface-node-header);

  /* === RGB-only variables for glass system (no alpha channel) === */
  /* Used in color-mix() to prevent alpha compounding */
  --node-bg-rgb: 13 13 20; /* Default dark mode RGB */

  /* === Edge Waypoint Handle Colors === */
  --edge-waypoint-color: var(--gui-accent-primary, rgb(59, 130, 246));
  --edge-waypoint-hover: var(--gui-accent-primary-hover, rgb(96, 165, 250));
  --edge-waypoint-active: var(--gui-accent-primary, rgb(59, 130, 246));
  --edge-waypoint-border: white;
  --edge-waypoint-glow: color-mix(in srgb, var(--gui-accent-primary, rgb(59, 130, 246)) 40%, transparent);
  --edge-waypoint-glow-active: color-mix(in srgb, var(--gui-accent-primary, rgb(59, 130, 246)) 60%, transparent);
  --edge-waypoint-add-bg: color-mix(in srgb, var(--gui-accent-primary, rgb(59, 130, 246)) 90%, transparent);
}

/* Light mode: explicit overrides to ensure node variables resolve correctly */
[data-theme="light"] {
  --node-bg: rgba(255, 255, 255, 0.95);
  --node-bg-secondary: rgba(243, 244, 246, 0.8);
  --node-header-bg: rgba(249, 250, 251, 0.5);
  --node-border-secondary: rgb(209, 213, 219);
  --node-text-primary: #111827;      /* gray-900 - very dark for light backgrounds */
  --node-text-secondary: #374151;    /* gray-700 - darker than before (was gray-600) */
  --node-text-muted: #4b5563;        /* gray-600 - darker than before (was gray-500) */

  /* RGB-only variable for glass system - light mode uses white base */
  --node-bg-rgb: 255 255 255;

  /* Light mode waypoint handles - darker border for contrast */
  --edge-waypoint-border: rgba(0, 0, 0, 0.8);
}

/* Dark mode: explicit overrides for light text on dark backgrounds */
[data-theme="dark"] {
  --node-bg: rgba(13, 13, 20, 0.95);
  --node-bg-secondary: rgba(30, 30, 40, 0.8);
  --node-header-bg: rgba(20, 20, 30, 0.5);
  --node-border-secondary: rgb(55, 65, 81);
  --node-text-primary: #ffffff;      /* pure white for maximum contrast */
  --node-text-secondary: #e5e7eb;    /* gray-200 - lighter than before (was gray-300) */
  --node-text-muted: #d1d5db;        /* gray-300 - lighter than before (was gray-400) */

  /* RGB-only variable for glass system - dark mode uses dark base */
  --node-bg-rgb: 13 13 20;

  /* Dark mode waypoint handles - lighter border for contrast */
  --edge-waypoint-border: rgba(255, 255, 255, 0.8);
}

/* =============================================================================
   NODE BASE STYLES
   ============================================================================= */

.cognograph-node {
  @apply rounded-lg border-2;
  background-color: var(--node-bg);
  min-width: 150px;
  min-height: 80px;
  /* Enable flex layout for responsive resizing */
  display: flex;
  flex-direction: column;
  /* Allow handles to overflow outside node bounds */
  overflow: visible;
  /* Use design token shadows */
  box-shadow: var(--shadow-node);
  /* CSS state machine transitions */
  transition:
    box-shadow var(--duration-normal, 150ms) var(--ease-out, ease-out),
    border-color var(--duration-normal, 150ms) var(--ease-out, ease-out),
    transform var(--duration-normal, 150ms) var(--ease-out, ease-out),
    filter var(--duration-normal, 150ms) var(--ease-out, ease-out);
}

/* Glass system integration - apply glass effects when enabled globally */
/* Neutral glass - no color tint, pure transparency */
html[data-glass-nodes="true"][data-glass-style="soft-blur"] .cognograph-node {
  backdrop-filter: blur(var(--glass-blur, 12px)) saturate(1.2) !important;
  -webkit-backdrop-filter: blur(var(--glass-blur, 12px)) saturate(1.2) !important;
  /* Use --glass-opacity variable with node accent color tint from --node-accent custom property */
  /* Tint percentage scales with opacity: 0% opacity → 0% tint, 85% opacity → 8%/12% tint */
  /* Strip alpha from --node-bg by using rgb() to get pure transparency */
  /* IMPORTANT: Must override base .cognograph-node background-color */
  background: linear-gradient(
    135deg,
    color-mix(in srgb, var(--node-accent, var(--node-conversation, rgb(59 130 246))) calc(var(--glass-opacity, 85) * 0.094%), color-mix(in srgb, rgb(var(--node-bg-rgb)) calc(var(--glass-opacity, 85) * 1%), transparent)) 0%,
    color-mix(in srgb, var(--node-accent, var(--node-conversation, rgb(59 130 246))) calc(var(--glass-opacity, 85) * 0.141%), color-mix(in srgb, rgb(var(--node-bg-rgb)) calc((var(--glass-opacity, 85) - 6) * 1%), transparent)) 100%
  ) !important;
  /* --node-accent is set per-node to border-color (theme token) → blue/purple/amber tint */
  /* Fallback chain: --node-accent → --node-conversation → blue rgb(59 130 246) */
  /* Tint coefficients: 0.094 = 8/85, 0.141 = 12/85 */
  contain: layout; /* Performance: isolate layout, preserve z-index */
  -webkit-transform: translateZ(0); /* Safari: force GPU layer */
  transform: translateZ(0);
}

html[data-glass-nodes="true"][data-glass-style="fluid-glass"] .cognograph-node {
  backdrop-filter: blur(calc(var(--glass-blur, 12px) * 2)) saturate(1.5) brightness(1.05) !important;
  -webkit-backdrop-filter: blur(calc(var(--glass-blur, 12px) * 2)) saturate(1.5) brightness(1.05) !important;
  /* Use --glass-opacity variable with node accent color tint for premium look */
  /* Tint percentage scales with opacity: 0% opacity → 0% tint, 85% opacity → 15%/20% tint */
  /* Strip alpha from --node-bg, add more color tint for fluid-glass */
  /* IMPORTANT: Must override base .cognograph-node background-color */
  background: linear-gradient(
    135deg,
    color-mix(in srgb, var(--node-accent, var(--node-conversation, rgb(59 130 246))) calc(var(--glass-opacity, 85) * 0.176%), color-mix(in srgb, rgb(var(--node-bg-rgb)) calc((var(--glass-opacity, 85) - 12) * 1%), transparent)) 0%,
    color-mix(in srgb, var(--node-accent, var(--node-conversation, rgb(59 130 246))) calc(var(--glass-opacity, 85) * 0.235%), color-mix(in srgb, rgb(var(--node-bg-rgb)) calc((var(--glass-opacity, 85) - 18) * 1%), transparent)) 100%
  ) !important;
  /* --node-accent is set per-node to border-color (theme token) → blue/purple/amber tint */
  /* Fallback chain: --node-accent → --node-conversation → blue rgb(59 130 246) */
  /* Tint coefficients: 0.176 = 15/85, 0.235 = 20/85 */
  box-shadow:
    var(--shadow-node),
    inset 0 1px 1px color-mix(in srgb, var(--gui-text-primary) 10%, transparent);
  contain: layout;
  -webkit-transform: translateZ(0);
  transform: translateZ(0);
}

/* Per-node override: force glass (even if global disabled) */
html[data-glass-style="soft-blur"] .cognograph-node[data-transparent="true"] {
  backdrop-filter: blur(var(--glass-blur, 12px)) saturate(1.2) !important;
  -webkit-backdrop-filter: blur(var(--glass-blur, 12px)) saturate(1.2) !important;
  /* Use --glass-opacity variable with node accent color tint */
  /* Tint percentage scales with opacity: 0% opacity → 0% tint, 85% opacity → 8%/12% tint */
  background: linear-gradient(
    135deg,
    color-mix(in srgb, var(--node-accent, var(--node-conversation, rgb(59 130 246))) calc(var(--glass-opacity, 85) * 0.094%), color-mix(in srgb, rgb(var(--node-bg-rgb)) calc(var(--glass-opacity, 85) * 1%), transparent)) 0%,
    color-mix(in srgb, var(--node-accent, var(--node-conversation, rgb(59 130 246))) calc(var(--glass-opacity, 85) * 0.141%), color-mix(in srgb, rgb(var(--node-bg-rgb)) calc((var(--glass-opacity, 85) - 6) * 1%), transparent)) 100%
  ) !important;
  contain: layout;
  -webkit-transform: translateZ(0);
  transform: translateZ(0);
}

html[data-glass-style="fluid-glass"] .cognograph-node[data-transparent="true"] {
  backdrop-filter: blur(calc(var(--glass-blur, 12px) * 2)) saturate(1.5) brightness(1.05) !important;
  -webkit-backdrop-filter: blur(calc(var(--glass-blur, 12px) * 2)) saturate(1.5) brightness(1.05) !important;
  /* Use --glass-opacity variable with more color tint */
  /* Tint percentage scales with opacity: 0% opacity → 0% tint, 85% opacity → 15%/20% tint */
  background: linear-gradient(
    135deg,
    color-mix(in srgb, var(--node-accent, var(--node-conversation, rgb(59 130 246))) calc(var(--glass-opacity, 85) * 0.176%), color-mix(in srgb, rgb(var(--node-bg-rgb)) calc((var(--glass-opacity, 85) - 12) * 1%), transparent)) 0%,
    color-mix(in srgb, var(--node-accent, var(--node-conversation, rgb(59 130 246))) calc(var(--glass-opacity, 85) * 0.235%), color-mix(in srgb, rgb(var(--node-bg-rgb)) calc((var(--glass-opacity, 85) - 18) * 1%), transparent)) 100%
  ) !important;
  box-shadow:
    var(--shadow-node),
    inset 0 1px 1px color-mix(in srgb, var(--gui-text-primary) 10%, transparent);
  contain: layout;
  -webkit-transform: translateZ(0);
  transform: translateZ(0);
}

/* Fallback for browsers without color-mix() support (IE11, old Android) */
@supports not (background: color-mix(in srgb, red, blue)) {
  .cognograph-node[data-transparent="true"],
  html[data-glass-nodes="true"] .cognograph-node {
    background: var(--node-bg) !important; /* Solid fallback */
    backdrop-filter: none !important;
    -webkit-backdrop-filter: none !important;
  }
}

/* Per-node override: force solid (even if global enabled) */
.cognograph-node[data-transparent="false"] {
  /* Don't override background - let inline styles handle node colors */
  backdrop-filter: none !important;
  -webkit-backdrop-filter: none !important;
  opacity: 1 !important;
}

/* Hover state: lift and enhanced shadow (only when not dragging or selected) */
.react-flow__node:not(.dragging) .cognograph-node:hover:not(.selected) {
  box-shadow: var(--shadow-node-hover);
  transform: translateY(-2px);
  filter: brightness(1.05);
}

/* Selected state: visible outline with enhanced shadow */
.cognograph-node.selected {
  @apply ring-2 ring-offset-2 ring-offset-gray-900;
  /* Ring color uses the --ring-color CSS variable set by each node's inline styles */
  --tw-ring-color: var(--ring-color, #6366f1);
  box-shadow: var(--shadow-node-selected);
  filter: brightness(1.08);
}

[data-theme="light"] .cognograph-node.selected {
  @apply ring-offset-white;
}

/* Dragging state: scale up with drop shadow */
/* Note: React Flow applies .dragging to .react-flow__node wrapper */
.react-flow__node.dragging .cognograph-node {
  transform: scale(1.02);
  box-shadow: var(--shadow-node-drag);
  filter: brightness(1.1);
}

/* Node type colors - using CSS variables from tokens */
.cognograph-node--conversation {
  border-color: var(--node-conversation);
}
/* z-index managed per-node via zIndex property for proper layering */
/* Ring color now uses --ring-color CSS variable from base .cognograph-node.selected */

/* Agent mode differentiation - glass effects only (border/bg set via inline styles) */
.conversation-node--agent {
  /* Glass effects: backdrop-filter for depth */
  backdrop-filter: blur(var(--glass-blur, 12px)) saturate(1.2);
  -webkit-backdrop-filter: blur(var(--glass-blur, 12px)) saturate(1.2);

  /* Subtle white inset highlight - reduced for agent mode (8% light, 5% dark) */
  box-shadow:
    0 4px 16px rgba(0, 0, 0, 0.18),
    inset 0 1px 0 color-mix(in srgb, white 8%, transparent);
}

/* Dark mode: even more subtle white inset (5%) */
[data-theme="dark"] .conversation-node--agent {
  box-shadow:
    0 4px 16px rgba(0, 0, 0, 0.18),
    inset 0 1px 0 color-mix(in srgb, white 5%, transparent);
}

.cognograph-node--project {
  /* Base styles - border-color set dynamically via inline styles */
  @apply flex flex-col;
  min-width: 250px;
  min-height: 200px;
  transition: box-shadow 0.2s ease-in-out, border-color 0.2s ease-in-out;
}

/* Disable hover effect for project nodes - prevents strobing when mousing over child nodes */
.cognograph-node--project:hover {
  filter: none;
  box-shadow: inherit;
}

/* React Flow node wrapper for project nodes - ensure they stay behind ALL edges */
.react-flow__node-project {
  z-index: -1 !important;
}

/* Visual feedback when project can receive drop */
.cognograph-node--project.drag-over {
  border-width: 4px;
  transform: scale(1.02);
  /* Use node's ring-color variable for consistent theming */
  box-shadow: 0 0 20px color-mix(in srgb, var(--ring-color) 40%, transparent);
}
/* Ring color now uses --ring-color CSS variable from base .cognograph-node.selected */

.cognograph-node--note {
  @apply border-amber-500;
}
/* z-index managed per-node via zIndex property */
/* Ring color now uses --ring-color CSS variable from base .cognograph-node.selected */

.cognograph-node--task {
  @apply border-emerald-500;
}
/* z-index managed per-node via zIndex property */
/* Ring color now uses --ring-color CSS variable from base .cognograph-node.selected */

.cognograph-node--artifact {
  @apply border-cyan-500;
}
/* z-index managed per-node via zIndex property */
/* Ring color now uses --ring-color CSS variable from base .cognograph-node.selected */

.cognograph-node--workspace {
  @apply border-red-500;
  min-width: 280px;
}
.react-flow__node-workspace {
  z-index: 5 !important;
}
/* Ring color now uses --ring-color CSS variable from base .cognograph-node.selected */

.cognograph-node--action {
  min-width: 220px;
}

.cognograph-node--action.action-node--inactive {
  opacity: 0.6;
  filter: grayscale(0.3);
}

/* Node header */
.cognograph-node__header {
  @apply flex items-center gap-2.5 px-3 py-2.5 border-b;
  background-color: var(--node-header-bg);
  /* Match parent's inner corner radius (rounded-lg 8px minus border-2 2px) */
  border-top-left-radius: calc(var(--radius-lg, 8px) - 2px);
  border-top-right-radius: calc(var(--radius-lg, 8px) - 2px);
  flex-shrink: 0;
  overflow: hidden;
}

/* Dark mode: darker border (mix node bg with black) */
[data-theme="dark"] .cognograph-node__header {
  border-color: color-mix(in srgb, var(--node-bg) 60%, black);
}

/* Light mode: lighter border (mix node bg with gray) */
[data-theme="light"] .cognograph-node__header {
  border-color: color-mix(in srgb, var(--node-bg) 70%, rgb(209, 213, 219));
}

.cognograph-node__icon {
  @apply w-5 h-5 flex-shrink-0;
  display: flex;
  align-items: center;
  justify-content: center;
}

.cognograph-node__title {
  @apply text-sm font-semibold truncate flex-1;
  color: var(--node-text-primary);
  line-height: 1.3;
}

/* Node title with node color - uses ring-color set by node type */
.cognograph-node__title--colored {
  color: var(--ring-color, var(--node-text-primary));
}

/* Node icon without background - uses ring-color for the icon color */
.cognograph-node__icon--colored {
  color: var(--ring-color);
  background: none !important;
}

/* Node body */
.cognograph-node__body {
  @apply px-3 py-2 text-sm;
  color: var(--node-text-secondary);
  /* Expand to fill available space and allow scrolling */
  flex: 1;
  overflow: hidden;
  min-height: 0;
  display: flex;
  flex-direction: column;
  gap: 6px;
  /* Allow clicks to pass through to children */
  cursor: default;
}

/* Node body content - description text */
.cognograph-node__body > p {
  margin: 0;
  line-height: 1.4;
}

/* Node body content - allow expansion to fill container */
.cognograph-node__body > pre,
.cognograph-node__body > div:first-child:not(.property-badges) {
  flex: 1;
  min-height: 0;
}

/* Property badges container */
.cognograph-node__body .property-badges {
  flex-shrink: 0;
  margin-top: auto;
}

/* Node footer */
.cognograph-node__footer {
  @apply flex items-center justify-between px-3 py-2 border-t text-xs;
  color: var(--node-text-muted);
  flex-shrink: 0;
  gap: 8px;
}

/* Dark mode: darker border (mix node bg with black) */
[data-theme="dark"] .cognograph-node__footer {
  border-color: color-mix(in srgb, var(--node-bg) 60%, black);
}

/* Light mode: lighter border (mix node bg with gray) */
[data-theme="light"] .cognograph-node__footer {
  border-color: color-mix(in srgb, var(--node-bg) 70%, rgb(209, 213, 219));
}

/* Resize handle */
.cognograph-node__resize {
  @apply absolute bottom-0 right-0 w-4 h-4 cursor-se-resize;
  @apply opacity-0 transition-opacity;
}

.cognograph-node:hover .cognograph-node__resize {
  @apply opacity-50;
}

.cognograph-node__resize:hover {
  @apply opacity-100;
}

/* =============================================================================
   HANDLE STYLES
   ============================================================================= */

.react-flow__handle {
  @apply border-2;
  background-color: var(--ring-color, #64748b);
  border-color: color-mix(in srgb, var(--ring-color, #64748b) 70%, white);
  @apply transition-[opacity,transform] duration-200 ease-out;
  /* Fixed sizing — avoids per-frame recalc during zoom */
  --handle-size: 16px;
  --handle-offset: -8px;
  width: var(--handle-size) !important;
  height: var(--handle-size) !important;
  /* Centering transform per-position (set by position rules below) */
  --handle-translate: translate(0, 0);
  /* Hidden by default, show on hover */
  opacity: 0;
  pointer-events: none;
  transform: var(--handle-translate) scale(0.8);
}

/* Fixed hit area for easier connections */
.react-flow__handle::before {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 40px;
  height: 40px;
  border-radius: 50%;
  pointer-events: auto;
}

/* Per-position centering and offset */
.react-flow__handle-top {
  --handle-translate: translateX(-50%);
  top: var(--handle-offset);
}

.react-flow__handle-bottom {
  --handle-translate: translateX(-50%);
  bottom: var(--handle-offset);
}

.react-flow__handle-left {
  --handle-translate: translateY(-50%);
  left: var(--handle-offset);
}

.react-flow__handle-right {
  --handle-translate: translateY(-50%);
  right: var(--handle-offset);
}

/* Show handles when node is hovered */
.cognograph-node:hover .react-flow__handle {
  background-color: var(--ring-color, #3b82f6);
  border-color: color-mix(in srgb, var(--ring-color, #3b82f6) 60%, white);
  box-shadow: 0 0 8px color-mix(in srgb, var(--ring-color, #3b82f6) 50%, transparent);
  opacity: 1;
  pointer-events: auto;
  transform: var(--handle-translate) scale(1);
}

/* Show handles when connecting (dragging from another handle) */
.react-flow__handle.connectingfrom,
.react-flow__handle.connectingto,
.react-flow.connecting .react-flow__handle {
  opacity: 1;
  pointer-events: auto;
  transform: var(--handle-translate) scale(1);
}

.react-flow__handle:hover {
  background-color: color-mix(in srgb, var(--ring-color, #3b82f6) 90%, white);
  border-color: white;
  transform: var(--handle-translate) scale(1.2);
  box-shadow: 0 0 6px var(--ring-color, #3b82f6);
}

/* Pulsing animation when connecting */
.react-flow__handle.connecting {
  animation: pulse-handle 1s ease-in-out infinite;
  opacity: 1;
}

@keyframes pulse-handle {
  0%, 100% { transform: var(--handle-translate) scale(1); opacity: 1; }
  50% { transform: var(--handle-translate) scale(1.2); opacity: 0.8; }
}

/* Connection target highlight - shows which handle will receive the connection */
.react-flow__handle.connection-target-highlight {
  opacity: 1 !important;
  pointer-events: auto !important;
  transform: var(--handle-translate) scale(1.6) !important;
  background-color: var(--target-highlight-color, #22c55e) !important;
  border-color: white !important;
  box-shadow:
    0 0 0 3px color-mix(in srgb, var(--target-highlight-color, #22c55e) 30%, transparent),
    0 0 20px var(--target-highlight-color, #22c55e),
    0 0 40px color-mix(in srgb, var(--target-highlight-color, #22c55e) 50%, transparent) !important;
  animation: connection-target-pulse 0.6s ease-in-out infinite !important;
  z-index: 1000 !important;
}

@keyframes connection-target-pulse {
  0%, 100% {
    transform: var(--handle-translate) scale(1.6);
    box-shadow:
      0 0 0 3px color-mix(in srgb, var(--target-highlight-color, #22c55e) 30%, transparent),
      0 0 20px var(--target-highlight-color, #22c55e),
      0 0 40px color-mix(in srgb, var(--target-highlight-color, #22c55e) 50%, transparent);
  }
  50% {
    transform: var(--handle-translate) scale(1.8);
    box-shadow:
      0 0 0 5px color-mix(in srgb, var(--target-highlight-color, #22c55e) 40%, transparent),
      0 0 30px var(--target-highlight-color, #22c55e),
      0 0 60px color-mix(in srgb, var(--target-highlight-color, #22c55e) 60%, transparent);
  }
}

/* Node glow when it's the connection target */
.react-flow__node:has(.connection-target-highlight) {
  box-shadow: 0 0 25px color-mix(in srgb, var(--target-highlight-color, #22c55e) 40%, transparent) !important;
}

/* =============================================================================
   EDGE STYLES
   ============================================================================= */

/* Ensure edge layer is interactive and above nodes when hovered/selected */
.react-flow__edges {
  pointer-events: none;
}

.react-flow__edge {
  pointer-events: visibleStroke;
}

/* When an edge is hovered or selected, bring it above other elements */
.react-flow__edge:hover,
.react-flow__edge.selected {
  z-index: 1000 !important;
}

.react-flow__edge-path {
  /* stroke colors handled by inline styles in CustomEdge.tsx */
  cursor: pointer;
  transition: stroke 0.15s ease, stroke-width 0.15s ease, filter 0.15s ease;
}

/* Sleeker edge styling */
.react-flow__edge-path {
  stroke-linecap: round;
  stroke-linejoin: round;
}

/* Edge interaction path - invisible wider path for easier clicking */
.react-flow__edge-interaction {
  stroke-width: 20;
  stroke: transparent;
  fill: none;
  pointer-events: stroke;
}

/* Reconnection handle styles - the circles at edge endpoints */
.react-flow__edgeupdater {
  cursor: grab;
  pointer-events: all;
}

.react-flow__edgeupdater circle {
  fill: #3b82f6;
  stroke: #1e40af;
  stroke-width: 1.5;
  r: 6;
  opacity: 0;
  transition: opacity 0.15s ease, r 0.15s ease, fill 0.15s ease;
}

/* Show handles on edge hover */
.react-flow__edge:hover .react-flow__edgeupdater circle {
  opacity: 1;
}

/* Enlarge and highlight handles on direct hover */
.react-flow__edgeupdater:hover circle {
  opacity: 1;
  r: 10;
  fill: #60a5fa;
  stroke: #3b82f6;
  stroke-width: 2;
  filter: drop-shadow(0 0 6px rgba(59, 130, 246, 0.7));
}

/* Pulsing animation when hovering reconnect handle */
.react-flow__edgeupdater:hover circle {
  animation: reconnect-pulse 0.8s ease-in-out infinite;
}

@keyframes reconnect-pulse {
  0%, 100% {
    r: 10;
    filter: drop-shadow(0 0 6px rgba(59, 130, 246, 0.7));
  }
  50% {
    r: 12;
    filter: drop-shadow(0 0 10px rgba(59, 130, 246, 0.9));
  }
}

/* When actively dragging the handle */
.react-flow__edgeupdater:active circle,
.react-flow__edgeupdater.active circle {
  fill: #22c55e;
  stroke: #16a34a;
  r: 12;
  animation: none;
  filter: drop-shadow(0 0 8px rgba(34, 197, 94, 0.8));
}

/* Show handles on selected edges always */
.react-flow__edge.selected .react-flow__edgeupdater circle {
  opacity: 1;
  r: 8;
}

/* All edges render above project nodes since projects have z-index: -1 */
.react-flow__edge g[data-intra-project="true"] {
  /* intraProject flag is kept for potential future styling but z-index is no longer needed */
}

/* =============================================================================
   FOCUS MODE EDGE STYLES
   When focus mode is active, all edges are dimmed except those connected
   to the focused node. Uses .focus-mode-active class on ReactFlow container.
   ============================================================================= */

/* Global edge dimming when focus mode is active */
.focus-mode-active .react-flow__edge .react-flow__edge-path {
  opacity: 0.1;
  filter: grayscale(100%);
  transition: opacity 0.3s ease, filter 0.3s ease;
}

/* Edges connected to focused node retain some visibility via hover restore */
.focus-mode-active .react-flow__edge:hover .react-flow__edge-path {
  opacity: 0.6;
  filter: grayscale(50%);
}

/* =============================================================================
   STATUS BADGES
   ============================================================================= */

.status-badge {
  @apply inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium;
}

/* =============================================================================
   NODE RESIZER STYLES
   ============================================================================= */

/* Make sure resize handles are visible */
.react-flow__resize-control {
  position: absolute !important;
  /* Hidden by default, shown on hover or selected */
  opacity: 0;
  transition: opacity 0.15s ease-in-out;
}

/* Show resize controls on node hover or when selected */
.react-flow__node:hover .react-flow__resize-control,
.react-flow__node.selected .react-flow__resize-control {
  opacity: 1;
  /* Don't enable pointer-events here - only on direct hover below */
}

.react-flow__resize-control.handle {
  width: 10px !important;
  height: 10px !important;
  /* Colors set via handleStyle prop on NodeResizer to match node color */
  border-radius: 2px !important;
  z-index: 100 !important;
}

.react-flow__resize-control.line {
  /* Colors set via lineStyle prop on NodeResizer to match node color */
  /* Visual border is thin but hit area is wider via the element itself */
  border-width: 2px !important;
}

/* Line handles - keep default positioning, just ensure they're visible */
.react-flow__resize-control.line.top {
  top: 0 !important;
}
.react-flow__resize-control.line.bottom {
  bottom: 0 !important;
}
.react-flow__resize-control.line.left {
  left: 0 !important;
}
.react-flow__resize-control.line.right {
  right: 0 !important;
}

/* Corner handles - centered on node corners */
.react-flow__resize-control.handle.top.left {
  top: -5px !important;
  left: -5px !important;
  cursor: nwse-resize !important;
}

.react-flow__resize-control.handle.top.right {
  /* Hidden to avoid overlap with AutoFitButton */
  display: none !important;
}

.react-flow__resize-control.handle.bottom.left {
  bottom: -5px !important;
  left: -5px !important;
  cursor: nesw-resize !important;
}

.react-flow__resize-control.handle.bottom.right {
  bottom: -5px !important;
  right: -5px !important;
  cursor: nwse-resize !important;
}

/* Edge handles (midpoint handles) - centered on edges */
.react-flow__resize-control.handle.top:not(.left):not(.right) {
  top: -5px !important;
  cursor: ns-resize !important;
}

.react-flow__resize-control.handle.bottom:not(.left):not(.right) {
  bottom: -5px !important;
  cursor: ns-resize !important;
}

.react-flow__resize-control.handle.left:not(.top):not(.bottom) {
  left: -5px !important;
  cursor: ew-resize !important;
}

.react-flow__resize-control.handle.right:not(.top):not(.bottom) {
  right: -5px !important;
  cursor: ew-resize !important;
}

/* Resize controls: hide line controls (they span entire edges and block clicks),
   show only corner handle controls on hover/selected (Figma-style pattern) */
.react-flow__resize-control.line {
  display: none !important;
}

/* Corner handles are small enough to not block content — show them */
.react-flow__resize-control.handle {
  pointer-events: auto !important;
}

.priority-badge {
  @apply inline-flex items-center gap-1 text-xs;
}

/* =============================================================================
   DISABLED NODE STYLES
   ============================================================================= */

.cognograph-node--disabled {
  @apply opacity-50;
  filter: grayscale(60%) blur(0.5px);
  pointer-events: auto; /* Keep interactive for selection */
}

.cognograph-node--disabled .cognograph-node__title {
  @apply text-gray-500;
}

.cognograph-node--disabled .cognograph-node__body {
  @apply text-gray-600;
}

.cognograph-node--disabled .cognograph-node__footer {
  @apply text-gray-600;
}

.cognograph-node--disabled .react-flow__handle {
  @apply opacity-30;
}

/* Light mode disabled styles */
[data-theme="light"] .cognograph-node--disabled {
  @apply opacity-60;
}

[data-theme="light"] .cognograph-node--disabled .cognograph-node__title {
  @apply text-gray-400;
}

[data-theme="light"] .cognograph-node--disabled .cognograph-node__body {
  @apply text-gray-400;
}

[data-theme="light"] .cognograph-node--disabled .cognograph-node__footer {
  @apply text-gray-400;
}

/* =============================================================================
   PINNED NODE INDICATOR
   Shows a subtle visual indicator when a node is pinned to a floating window
   ============================================================================= */

/* =============================================================================
   NODE SHAPE VARIANTS
   Shape classes that override border-radius for different visual styles
   ============================================================================= */

/* Rectangle - Default shape with minimal rounding (already applied via .cognograph-node) */
.node-shape-rectangle {
  border-radius: 4px !important;
}

/* Rounded - Softer, more friendly appearance */
.node-shape-rounded {
  border-radius: 12px !important;
}

/* Pill - Fully rounded ends (for tags, quick items) */
.node-shape-pill {
  border-radius: 9999px !important;
}

/* Hexagon - Special/milestone nodes */
.node-shape-hexagon {
  clip-path: polygon(25% 0%, 75% 0%, 100% 50%, 75% 100%, 25% 100%, 0% 50%);
  border-radius: 0 !important;
  /* Adjust padding to account for clipped corners */
  padding-left: 16px;
  padding-right: 16px;
}

/* Hexagon needs a visible border simulation since clip-path cuts the border */
.node-shape-hexagon::before {
  content: '';
  position: absolute;
  inset: -2px;
  clip-path: polygon(25% 0%, 75% 0%, 100% 50%, 75% 100%, 25% 100%, 0% 50%);
  background: var(--tw-border-opacity, 1) var(--node-border-color, currentColor);
  z-index: -1;
}

/* =============================================================================
   SHIFT+DRAG EDGE CREATION CURSOR FEEDBACK
   When Shift is held, nodes show crosshair cursor to indicate edge creation mode
   ============================================================================= */

/* Show crosshair cursor on nodes when Shift is held (ready to drag) */
.shift-drag-ready .react-flow__node {
  cursor: crosshair !important;
}

/* Tooltip-like visual hint when hovering nodes with Shift held */
.shift-drag-ready .react-flow__node::after {
  content: 'Drag to connect';
  position: absolute;
  bottom: calc(100% + 8px);
  left: 50%;
  transform: translateX(-50%);
  padding: 4px 8px;
  background: var(--surface-overlay, rgba(0, 0, 0, 0.85));
  color: var(--text-primary, white);
  border-radius: 4px;
  font-size: 11px;
  white-space: nowrap;
  pointer-events: none;
  opacity: 0;
  transition: opacity 0.15s;
  z-index: 1000;
}

.shift-drag-ready .react-flow__node:hover::after {
  opacity: 1;
}

/* During active drag, show grabbing cursor */
.shift-drag-active {
  cursor: grabbing !important;
}

.shift-drag-active * {
  cursor: inherit !important;
}

/* =============================================================================
   AUTO-FIT BUTTON
   Button that appears on selected nodes to fit dimensions to content
   ============================================================================= */

.auto-fit-button {
  position: absolute;
  top: -8px;
  right: -8px;
  width: 20px;
  height: 20px;
  border-radius: 4px;
  background-color: var(--button-color, var(--gui-accent-primary));
  border: 2px solid white;
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  opacity: 0.9;
  transition:
    transform 0.15s ease,
    opacity 0.15s ease,
    box-shadow 0.15s ease;
  z-index: 100;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}

.auto-fit-button:hover {
  opacity: 1;
  transform: scale(1.15);
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
}

.auto-fit-button:active {
  transform: scale(0.95);
}

/* Light mode adjustments */
[data-theme="light"] .auto-fit-button {
  border-color: rgba(0, 0, 0, 0.2);
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
}

[data-theme="light"] .auto-fit-button:hover {
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
}

/* =============================================================================
   FOLD BADGE
   Badge that appears on nodes with children, allowing collapse/expand
   ============================================================================= */

.fold-badge {
  position: absolute;
  bottom: -8px;
  right: 8px;
  display: flex;
  align-items: center;
  gap: 2px;
  padding: 2px 6px;
  border-radius: 10px;
  background-color: var(--badge-color, var(--gui-accent-primary));
  border: 2px solid white;
  color: white;
  font-size: 10px;
  font-weight: 600;
  cursor: pointer;
  opacity: 0.9;
  transition:
    transform 0.15s ease,
    opacity 0.15s ease,
    box-shadow 0.15s ease;
  z-index: 100;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}

.fold-badge:hover {
  opacity: 1;
  transform: scale(1.1);
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
}

.fold-badge:active {
  transform: scale(0.95);
}

.fold-badge__count {
  font-size: 9px;
  font-weight: 700;
}

/* Light mode adjustments */
[data-theme="light"] .fold-badge {
  border-color: rgba(0, 0, 0, 0.2);
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
}

/* =============================================================================
   NODE FOLDING ANIMATIONS
   Smooth transitions for nodes being collapsed/expanded
   ============================================================================= */

/* Nodes that are being hidden due to parent collapse */
.cognograph-node.node-collapsing {
  animation: node-collapse 0.2s ease-out forwards;
}

@keyframes node-collapse {
  from {
    opacity: 1;
    transform: scale(1);
  }
  to {
    opacity: 0;
    transform: scale(0.8);
  }
}

/* Nodes that are being shown due to parent expand */
.cognograph-node.node-expanding {
  animation: node-expand 0.3s ease-out forwards;
}

@keyframes node-expand {
  from {
    opacity: 0;
    transform: scale(0.8);
  }
  to {
    opacity: 1;
    transform: scale(1);
  }
}

/* =============================================================================
   TEXT NODE STYLES
   ============================================================================= */

.text-node {
  @apply rounded-md transition-[box-shadow,border-color] duration-150;
  min-width: 100px;
  min-height: 30px;
  display: flex;
  flex-direction: column;
  overflow: visible;
  background: transparent;
}

.text-node.selected {
  /* Selection glow uses --ring-color set by inline styles */
}

.text-node-body {
  flex: 1;
  min-height: 20px;
  padding: 4px 6px;
  color: var(--node-text-primary);
  cursor: default;
  position: relative; /* Required for ::before placeholder pseudo-element */
}

/* Text node content heading styles */
.text-node-body h1 {
  font-size: 1.5em;
  font-weight: 700;
  margin: 0 0 0.3em;
  line-height: 1.2;
}

.text-node-body h2 {
  font-size: 1.25em;
  font-weight: 600;
  margin: 0 0 0.25em;
  line-height: 1.3;
}

.text-node-body h3 {
  font-size: 1.1em;
  font-weight: 600;
  margin: 0 0 0.2em;
  line-height: 1.3;
}

/* Text node list styles */
.text-node-body ul,
.text-node-body ol {
  margin: 0.2em 0;
  padding-left: 1.2em;
}

.text-node-body li {
  margin: 0.1em 0;
}

/* Handles: smaller, more subtle on text nodes */
.text-node .react-flow__handle {
  --handle-size: 10px;
  --handle-offset: -5px;
}

/* Placeholder text for empty text nodes */
.text-node-body .tiptap p.is-editor-empty:first-child::before {
  color: var(--node-text-muted);
  content: attr(data-placeholder);
  float: left;
  height: 0;
  pointer-events: none;
  font-style: italic;
  opacity: 0.6;
}

/* =============================================================================
   PINNED NODE INDICATOR (Flexible Positioning) — DISABLED
   Currently every dragged node is auto-pinned (App.tsx onNodeDragStop) with no
   way to unpin, so the indicator shows on nearly every node = visual noise.
   TODO: Revisit when auto-layout features land — add toggle UI, show indicator
   only when layout engine is active, and let users unpin nodes.
   See: layout-pinned system (layoutMode: 'pinned' on node data)
   ============================================================================= */

/* Old pinned style for backward compatibility (different from layout-pinned) */
.cognograph-node.node--pinned {
  /* Reserved for future use - currently no special styling */
}

/* =============================================================================
   CUT NODE INDICATOR
   Shows dimmed/dashed visual when nodes are cut (pending paste)
   ============================================================================= */

.cognograph-node.cognograph-node--cut {
  opacity: 0.5;
  outline: 2px dashed rgba(234, 179, 8, 0.7);
  outline-offset: 4px;
  transition: opacity 0.2s, outline 0.2s;
}

.cognograph-node.cognograph-node--cut .react-flow__handle {
  opacity: 0.3 !important;
}

/* TextNode cut style */
.text-node.text-node--cut {
  opacity: 0.5;
  outline: 2px dashed rgba(234, 179, 8, 0.7);
  outline-offset: 4px;
  transition: opacity 0.2s, outline 0.2s;
}

/* =============================================================================
   SHOW MEMBERS MODE - DIM NON-MEMBERS
   When viewing project membership, non-member nodes are dimmed
   ============================================================================= */

.cognograph-node.cognograph-node--non-member {
  opacity: 0.35;
  filter: grayscale(40%) blur(0.3px);
  transition: opacity 0.3s ease, filter 0.3s ease;
}

.cognograph-node.cognograph-node--non-member:hover {
  opacity: 0.6;
  filter: grayscale(20%);
}

/* =============================================================================
   ENHANCED FOCUS MODE - More aggressive dimming for unconnected nodes
   Based on MindNode's calm design: unfocused elements should virtually disappear
   ============================================================================= */

/* Focus mode: Unfocused nodes get very aggressive dimming */
.cognograph-node.cognograph-node--focus-unfocused {
  opacity: 0.15;
  filter: grayscale(50%) blur(0.5px);
  transition: opacity 0.3s ease, filter 0.3s ease;
  pointer-events: none; /* Disable interaction with unfocused nodes */
}

.cognograph-node.cognograph-node--focus-unfocused:hover {
  opacity: 0.25;
  filter: grayscale(40%);
  pointer-events: auto;
}

/* Text nodes in focus mode */
.text-node.text-node--focus-unfocused {
  opacity: 0.15;
  filter: grayscale(50%) blur(0.5px);
  transition: opacity 0.3s ease, filter 0.3s ease;
  pointer-events: none;
}

.text-node.text-node--focus-unfocused:hover {
  opacity: 0.25;
  filter: grayscale(40%);
  pointer-events: auto;
}

.cognograph-node.cognograph-node--member-highlight {
  box-shadow: 0 0 0 3px var(--ring-color, #6366f1), 0 0 20px color-mix(in srgb, var(--ring-color, #6366f1) 40%, transparent);
}

/* =============================================================================
   FOCUS MODE NEIGHBORHOOD - Lighter dimming for connected nodes
   Keeps spatial context visible while highlighting focused area
   ============================================================================= */

.cognograph-node.cognograph-node--focus-neighbor {
  opacity: 0.65;
  filter: grayscale(15%);
  transition: opacity 0.3s ease, filter 0.3s ease;
}

.cognograph-node.cognograph-node--focus-neighbor:hover {
  opacity: 0.85;
  filter: grayscale(5%);
}

.text-node.text-node--focus-neighbor {
  opacity: 0.65;
  filter: grayscale(15%);
  transition: opacity 0.3s ease, filter 0.3s ease;
}

.text-node.text-node--focus-neighbor:hover {
  opacity: 0.85;
  filter: grayscale(5%);
}

/* Non-member text nodes */
.text-node.text-node--non-member {
  opacity: 0.35;
  filter: grayscale(40%) blur(0.3px);
  transition: opacity 0.3s ease, filter 0.3s ease;
}

.text-node.text-node--non-member:hover {
  opacity: 0.6;
  filter: grayscale(20%);
}

/* =============================================================================
   FADE-IN ANIMATION - For suggested actions and other UI elements
   ============================================================================= */

@keyframes fade-in {
  from {
    opacity: 0;
    transform: translateY(4px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.animate-fade-in {
  animation: fade-in 0.2s ease-out;
}

/* =============================================================================
   TASK COMPLETION CELEBRATION - ND dopamine hit
   ============================================================================= */

@keyframes celebrate-pulse {
  0% {
    box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7);
    transform: scale(1);
  }
  50% {
    box-shadow: 0 0 0 15px rgba(34, 197, 94, 0);
    transform: scale(1.02);
  }
  100% {
    box-shadow: 0 0 0 0 rgba(34, 197, 94, 0);
    transform: scale(1);
  }
}

.cognograph-node.cognograph-node--celebrating {
  animation: celebrate-pulse 0.6s ease-out;
  border-color: rgb(34, 197, 94) !important;
}

/* =============================================================================
   VISUAL BOOKMARK - Flag node as current focus (ND feature)
   ============================================================================= */

.cognograph-node.cognograph-node--bookmarked {
  box-shadow:
    0 0 0 2px rgba(251, 191, 36, 0.5),
    0 0 20px rgba(251, 191, 36, 0.3),
    var(--tw-shadow, 0 0 #0000);
}

.cognograph-node.cognograph-node--bookmarked::before {
  content: '';
  position: absolute;
  top: -8px;
  right: -8px;
  width: 16px;
  height: 16px;
  background: rgb(251, 191, 36);
  border-radius: 50%;
  z-index: 10;
  box-shadow: 0 0 8px rgba(251, 191, 36, 0.5);
}

/* Star icon inside the bookmark indicator */
.cognograph-node.cognograph-node--bookmarked::after {
  content: '★';
  position: absolute;
  top: -8px;
  right: -8px;
  width: 16px;
  height: 16px;
  font-size: 10px;
  line-height: 16px;
  text-align: center;
  color: rgb(55, 48, 23);
  z-index: 11;
}

/* =============================================================================
   NUMBERED BOOKMARK BADGES (1-9 keys) - Instant spatial anchors
   Each number has a distinct color for quick visual identification
   ============================================================================= */

/* =============================================================================
   PFD PHASE 6C: SESSION RE-ENTRY — RECENCY INDICATORS
   ============================================================================= */

/* Nodes modified within 24 hours get a subtle fresh indicator */
.react-flow__node.recency-fresh .cognograph-node {
  box-shadow: 0 0 6px 1px rgba(34, 197, 94, 0.15);
}

/* Nodes modified 24-48 hours ago get a fainter warm indicator */
.react-flow__node.recency-warm .cognograph-node {
  box-shadow: 0 0 4px 1px rgba(34, 197, 94, 0.06);
}

@media (prefers-reduced-motion: reduce) {
  .react-flow__node.recency-fresh .cognograph-node,
  .react-flow__node.recency-warm .cognograph-node {
    box-shadow: none;
    border-left: 3px solid rgba(34, 197, 94, 0.25);
  }
}

/* Session re-entry prompt */
.session-reentry-prompt {
  position: fixed;
  top: 72px;
  left: 50%;
  transform: translateX(-50%);
  z-index: 50;
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 12px;
  background: var(--gui-panel-bg, rgba(30, 30, 30, 0.95));
  border: 1px solid var(--gui-border, rgba(255, 255, 255, 0.1));
  border-radius: 8px;
  box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
  backdrop-filter: blur(12px);
  animation: reentry-slide-in 300ms ease-out;
}

@keyframes reentry-slide-in {
  from { opacity: 0; transform: translateX(-50%) translateY(-8px); }
  to { opacity: 1; transform: translateX(-50%) translateY(0); }
}

.session-reentry-prompt__text {
  font-size: 0.8rem;
  color: var(--gui-text-secondary, #aaa);
}

.session-reentry-prompt__action {
  cursor: pointer;
  background: rgba(34, 197, 94, 0.15);
  border: 1px solid rgba(34, 197, 94, 0.3);
  color: #22c55e;
  font-size: 0.8rem;
  padding: 3px 8px;
  border-radius: 4px;
  transition: background 150ms ease;
}

.session-reentry-prompt__action:hover {
  background: rgba(34, 197, 94, 0.25);
}

.session-reentry-prompt__dismiss {
  cursor: pointer;
  background: none;
  border: none;
  color: var(--gui-text-tertiary, #666);
  font-size: 1rem;
  padding: 0 4px;
  line-height: 1;
}

.session-reentry-prompt__dismiss:hover {
  color: var(--gui-text-secondary, #aaa);
}

@media (prefers-reduced-motion: reduce) {
  .session-reentry-prompt {
    animation: none;
  }
}

/* PFD Phase 6B: Landmark badge — always visible, all zoom levels */
.landmark-badge {
  position: absolute;
  top: -6px;
  right: -6px;
  width: 16px;
  height: 16px;
  font-size: 12px;
  line-height: 16px;
  text-align: center;
  color: #c8963e;
  z-index: 5;
  pointer-events: none;
}

/* Landmark badge stays visible at all zoom levels */
.note-node--lod-ultra-far .landmark-badge,
.note-node--lod-far .landmark-badge,
.note-node--lod-mid .landmark-badge {
  display: block;
}

.numbered-bookmark-badge {
  position: absolute;
  top: -7px;
  left: -7px;
  width: 18px;
  height: 18px;
  border-radius: 4px;
  font-size: 11px;
  font-weight: 700;
  line-height: 18px;
  text-align: center;
  color: white;
  z-index: 20;
  background: rgba(0, 0, 0, 0.6);
  border: 1.5px solid var(--bm-color, #64748b);
  box-shadow: 0 1px 4px rgba(0, 0, 0, 0.3);
  transition: transform 0.1s ease, background 0.1s ease;
  cursor: pointer;
}

.numbered-bookmark-badge:hover {
  transform: scale(1.15);
  background: rgba(0, 0, 0, 0.8);
}

[data-theme="light"] .numbered-bookmark-badge {
  background: rgba(255, 255, 255, 0.85);
  color: #1e293b;
}

[data-theme="light"] .numbered-bookmark-badge:hover {
  background: rgba(255, 255, 255, 0.95);
}

/* 9 distinct accent colors — border only, no gradients */
.numbered-bookmark-badge--1 { --bm-color: #ef4444; }
.numbered-bookmark-badge--2 { --bm-color: #f97316; }
.numbered-bookmark-badge--3 { --bm-color: #eab308; }
.numbered-bookmark-badge--4 { --bm-color: #22c55e; }
.numbered-bookmark-badge--5 { --bm-color: #14b8a6; }
.numbered-bookmark-badge--6 { --bm-color: #3b82f6; }
.numbered-bookmark-badge--7 { --bm-color: #8b5cf6; }
.numbered-bookmark-badge--8 { --bm-color: #ec4899; }
.numbered-bookmark-badge--9 { --bm-color: #6366f1; }

/* =============================================================================
   SEMANTIC ZOOM - Content scales with zoom, never hidden
   Philosophy: Fade don't hide. Preserve visual context at all zoom levels.
   ============================================================================= */

/* =============================================================================
   Shared LOD Rules (Phase 1B) — CSS-driven LOD via data-lod attribute.
   Applied to all node types via [data-lod] attribute selectors.
   These complement per-node LOD rules (e.g. .note-node--lod-far) below.
   ============================================================================= */

/* Ultra-far: Colored dot mode — collapse to minimum, hide all sections */
[data-lod="ultra-far"] {
  min-height: 24px;
  contain: content;
}

[data-lod="ultra-far"] .cognograph-node__header,
[data-lod="ultra-far"] .cognograph-node__body,
[data-lod="ultra-far"] .cognograph-node__footer {
  display: none;
}

/* Far: Shape + color mode — body non-interactive, footer hidden */
[data-lod="far"] .cognograph-node__body {
  pointer-events: none;
}

[data-lod="far"] .cognograph-node__footer {
  display: none;
}

/* Mid: Summary card mode — footer slightly dimmed */
[data-lod="mid"] .cognograph-node__footer {
  opacity: 0.7;
}

/* Ultra-close: Expanded detail mode — no height caps */
[data-lod="ultra-close"] {
  max-height: none;
}

/* =============================================================================
   Artboard Classes (Phase 3C) — Card-to-artboard transition animations.
   Card identity persists: accent color, glow ring, dimmed surroundings.
   ============================================================================= */

/* Primary artboard node: elevated with outer glow ring matching accent color */
.artboard-primary {
  z-index: 10;
  box-shadow:
    0 0 0 3px var(--node-accent, var(--accent)),
    0 0 24px color-mix(in srgb, var(--node-accent, #6366f1) 35%, transparent),
    0 0 48px color-mix(in srgb, var(--node-accent, #6366f1) 15%, transparent);
  transition: box-shadow 300ms ease-out;
}

/* Dimmed (non-primary) nodes: faded with blur and no interaction */
.artboard-dimmed {
  opacity: 0.4;
  filter: blur(1px);
  pointer-events: none;
  transition: opacity 300ms ease-out, filter 300ms ease-out;
}

/* Width/height expansion transition for the expanding node */
.artboard-transition {
  transition: width 300ms ease-out, height 300ms ease-out, box-shadow 300ms ease-out;
}

/* Artboard accent bar — left border emphasizing card identity */
.node-artboard__header--accented {
  border-left: 3px solid var(--node-accent, #6366f1);
}

/* Close button escape hint */
.node-artboard__header-close-hint {
  font-size: 10px;
  color: var(--text-muted, #666);
  margin-left: 2px;
  opacity: 0.7;
}

@media (prefers-reduced-motion: reduce) {
  .artboard-primary,
  .artboard-dimmed,
  .artboard-transition {
    transition: none;
  }
}

/* =============================================================================
   Per-Node LOD (Level of Detail) — True content switching, not opacity fading.
   PFD Phase 1: Nodes render different DOM at each zoom level.
   LOD transitions animate with 200ms ease for object constancy.
   ============================================================================= */

/* LOD transition animation (respects reduced motion preference) */
.note-node--lod-ultra-far .cognograph-node__body,
.note-node--lod-far .cognograph-node__body,
.note-node--lod-mid .cognograph-node__body,
.note-node--lod-close .cognograph-node__body,
.note-node--lod-ultra-close .cognograph-node__body,
.note-node--lod-ultra-far .cognograph-node__footer,
.note-node--lod-far .cognograph-node__footer,
.note-node--lod-mid .cognograph-node__footer,
.note-node--lod-close .cognograph-node__footer,
.note-node--lod-ultra-close .cognograph-node__footer {
  transition: opacity 200ms ease-out, max-height 200ms ease-out;
}

@media (prefers-reduced-motion: reduce) {
  .note-node--lod-ultra-far .cognograph-node__body,
  .note-node--lod-far .cognograph-node__body,
  .note-node--lod-mid .cognograph-node__body,
  .note-node--lod-close .cognograph-node__body,
  .note-node--lod-ultra-close .cognograph-node__body,
  .note-node--lod-ultra-far .cognograph-node__footer,
  .note-node--lod-far .cognograph-node__footer,
  .note-node--lod-mid .cognograph-node__footer,
  .note-node--lod-close .cognograph-node__footer,
  .note-node--lod-ultra-close .cognograph-node__footer {
    transition: none;
  }
}

/* Ultra-far zoom: Cluster/shapes mode — shape + color only, no text */
.note-node--lod-ultra-far .cognograph-node__body {
  pointer-events: none;
}

.note-node--lod-ultra-far .cognograph-node__footer {
  opacity: 0;
  pointer-events: none;
}

.note-node--lod-ultra-far .property-badges {
  display: none;
}

.note-node--lod-ultra-far .cognograph-node__header {
  opacity: 0;
  pointer-events: none;
}

/* Far zoom: Show structured content preview — non-interactive but visible */
.note-node--lod-far .cognograph-node__body {
  pointer-events: none;
  overflow: hidden;
}

.note-node--lod-far .cognograph-node__footer {
  opacity: 0;
  pointer-events: none;
}

.note-node--lod-far .property-badges {
  display: none;
}

/* Hidden body wrapper for TipTap preservation at far zoom */
.note-node__body-hidden {
  visibility: hidden;
  height: 0;
  overflow: hidden;
  pointer-events: none;
}

/* Ultra-far zoom: Make numbered bookmarks even more prominent */
.note-node--lod-ultra-far .numbered-bookmark-badge {
  transform: scale(1.8);
  opacity: 1;
}

.note-node--lod-ultra-far .numbered-bookmark-badge:hover {
  transform: scale(2.0);
}

/* Far zoom: Make numbered bookmarks more prominent (they're navigation aids) */
.note-node--lod-far .numbered-bookmark-badge {
  transform: scale(1.5);
  opacity: 1;
}

.note-node--lod-far .numbered-bookmark-badge:hover {
  transform: scale(1.7);
}

/* Mid zoom: Summary card mode — title + lede + badges */
.note-node--lod-mid .cognograph-node__footer {
  opacity: 0.7;
}

.note-node--lod-mid .property-badges {
  opacity: 0.8;
}

/* Close zoom: Document mode — full rendering (default behavior) */
.note-node--lod-close .cognograph-node__body {
  opacity: 1;
  max-height: none;
}

.note-node--lod-close .cognograph-node__footer {
  opacity: 1;
}

.note-node--lod-close .property-badges {
  opacity: 1;
}

/* Ultra-close zoom: Enhanced document mode — full rendering + expanded toolbar */
.note-node--lod-ultra-close .cognograph-node__body {
  opacity: 1;
  max-height: none;
}

.note-node--lod-ultra-close .cognograph-node__footer {
  opacity: 1;
}

.note-node--lod-ultra-close .property-badges {
  opacity: 1;
}

/* =============================================================================
   LOD for OrchestratorNode — orchestrator-node--lod-{far|mid|close}
   ============================================================================= */

/* LOD transition animation */
.orchestrator-node--lod-far .cognograph-node__body,
.orchestrator-node--lod-mid .cognograph-node__body,
.orchestrator-node--lod-close .cognograph-node__body,
.orchestrator-node--lod-far .cognograph-node__footer,
.orchestrator-node--lod-mid .cognograph-node__footer,
.orchestrator-node--lod-close .cognograph-node__footer {
  transition: opacity 200ms ease-out, max-height 200ms ease-out;
}

@media (prefers-reduced-motion: reduce) {
  .orchestrator-node--lod-far .cognograph-node__body,
  .orchestrator-node--lod-mid .cognograph-node__body,
  .orchestrator-node--lod-close .cognograph-node__body,
  .orchestrator-node--lod-far .cognograph-node__footer,
  .orchestrator-node--lod-mid .cognograph-node__footer,
  .orchestrator-node--lod-close .cognograph-node__footer {
    transition: none;
  }
}

.orchestrator-node--lod-far .cognograph-node__body {
  pointer-events: none;
}

.orchestrator-node--lod-far .cognograph-node__footer {
  opacity: 0;
  pointer-events: none;
}

.orchestrator-node--lod-mid .cognograph-node__footer {
  opacity: 0.7;
}

/* =============================================================================
   LOD for ActionNode — action-node--lod-{far|mid|close}
   ============================================================================= */

.action-node--lod-far .cognograph-node__body,
.action-node--lod-mid .cognograph-node__body,
.action-node--lod-close .cognograph-node__body,
.action-node--lod-far .cognograph-node__footer,
.action-node--lod-mid .cognograph-node__footer,
.action-node--lod-close .cognograph-node__footer {
  transition: opacity 200ms ease-out, max-height 200ms ease-out;
}

@media (prefers-reduced-motion: reduce) {
  .action-node--lod-far .cognograph-node__body,
  .action-node--lod-mid .cognograph-node__body,
  .action-node--lod-close .cognograph-node__body,
  .action-node--lod-far .cognograph-node__footer,
  .action-node--lod-mid .cognograph-node__footer,
  .action-node--lod-close .cognograph-node__footer {
    transition: none;
  }
}

.action-node--lod-far .cognograph-node__body {
  pointer-events: none;
}

.action-node--lod-far .cognograph-node__footer {
  opacity: 0;
  pointer-events: none;
}

.action-node--lod-mid .cognograph-node__footer {
  opacity: 0.7;
}

/* =============================================================================
   LOD for WorkspaceNode — workspace-node--lod-{far|mid|close}
   ============================================================================= */

.workspace-node--lod-far .cognograph-node__body,
.workspace-node--lod-mid .cognograph-node__body,
.workspace-node--lod-close .cognograph-node__body,
.workspace-node--lod-far .cognograph-node__footer,
.workspace-node--lod-mid .cognograph-node__footer,
.workspace-node--lod-close .cognograph-node__footer {
  transition: opacity 200ms ease-out, max-height 200ms ease-out;
}

@media (prefers-reduced-motion: reduce) {
  .workspace-node--lod-far .cognograph-node__body,
  .workspace-node--lod-mid .cognograph-node__body,
  .workspace-node--lod-close .cognograph-node__body,
  .workspace-node--lod-far .cognograph-node__footer,
  .workspace-node--lod-mid .cognograph-node__footer,
  .workspace-node--lod-close .cognograph-node__footer {
    transition: none;
  }
}

.workspace-node--lod-far .cognograph-node__body {
  pointer-events: none;
}

.workspace-node--lod-far .cognograph-node__footer {
  opacity: 0;
  pointer-events: none;
}

.workspace-node--lod-mid .cognograph-node__footer {
  opacity: 0.7;
}

/* Workspace member count badge - elevated z-index at far zoom */
.workspace-node--lod-far {
  z-index: 2;
}

/* =============================================================================
   LOD for TextNode — text-node--lod-{far|mid|close}
   ============================================================================= */

.text-node--lod-far .text-node-body,
.text-node--lod-mid .text-node-body,
.text-node--lod-close .text-node-body {
  transition: opacity 200ms ease-out;
}

@media (prefers-reduced-motion: reduce) {
  .text-node--lod-far .text-node-body,
  .text-node--lod-mid .text-node-body,
  .text-node--lod-close .text-node-body {
    transition: none;
  }
}

.text-node--lod-far {
  pointer-events: none;
}

.text-node--lod-far .text-node-body {
  pointer-events: none;
}

/* Expand trigger button (replaces passive "..." indicator) */
.cognograph-node__expand-trigger {
  cursor: pointer;
  background: none;
  border: none;
  color: var(--salt-11, #888);
  font-size: 0.75rem;
  padding: 2px 6px;
  border-radius: 3px;
  text-align: center;
  width: 100%;
  transition: background-color 150ms ease;
}

.cognograph-node__expand-trigger:hover {
  background-color: var(--salt-a4, rgba(128,128,128,0.1));
  color: var(--salt-12, #fff);
}

/* Focus mode trigger button (appears in header on hover at close zoom) */
.cognograph-node__focus-trigger {
  cursor: pointer;
  background: none;
  border: none;
  color: var(--node-text-secondary, #888);
  padding: 2px;
  border-radius: 3px;
  opacity: 0;
  flex-shrink: 0;
  transition: opacity 150ms ease, background-color 150ms ease;
}

.cognograph-node:hover .cognograph-node__focus-trigger,
.cognograph-node__focus-trigger:focus-visible {
  opacity: 0.6;
}

.cognograph-node__focus-trigger:hover {
  opacity: 1;
  background-color: var(--salt-a4, rgba(128,128,128,0.1));
}

/* =============================================================================
   Content Density Brackets

   Color = NoteMode type (via --density-accent CSS variable).
   Geometry = content density (progressive border treatment).

   Far zoom: 3 tiers (empty, has-content, dense)
   Mid/Close zoom: 5 tiers (empty, sparse, medium, substantial, dense)
   ============================================================================= */

/* --- Tier 1: Empty (0-30 words) — Standard frame only --- */
.density--empty {
  /* No additional treatment — standard 1px border from node mode */
}

/* --- Tier 2 (far): Has Content (31-299 words) — Left accent bar --- */
.density--has-content {
  border-left: 3px solid var(--density-accent, var(--node-accent)) !important;
}

/* --- Tier 2 (mid/close): Sparse (31-99 words) — Left bracket --- */
.density--sparse {
  border-left: 3px solid var(--density-accent, var(--node-accent)) !important;
}

/* --- Tier 3 (mid/close): Medium (100-299 words) — Left bracket + top bar --- */
.density--medium {
  border-left: 3px solid var(--density-accent, var(--node-accent)) !important;
  border-top: 3px solid var(--density-accent, var(--node-accent)) !important;
}

/* --- Tier 4 (mid/close): Substantial (300-599 words) — Corner notch (L-shaped) --- */
.density--substantial {
  position: relative;
}

.density--substantial::before {
  content: '';
  position: absolute;
  top: -1px;
  left: -1px;
  width: 32px;
  height: 3px;
  background: var(--density-accent, var(--node-accent));
  z-index: 1;
  pointer-events: none;
  border-radius: 2px 0 0 0;
}

.density--substantial::after {
  content: '';
  position: absolute;
  top: -1px;
  left: -1px;
  width: 3px;
  height: 32px;
  background: var(--density-accent, var(--node-accent));
  z-index: 1;
  pointer-events: none;
  border-radius: 2px 0 0 0;
}

/* --- Tier 5: Dense (600+ words) — Extended corner notch --- */
.density--dense {
  position: relative;
}

.density--dense::before {
  content: '';
  position: absolute;
  top: -1px;
  left: -1px;
  width: 48px;
  height: 3px;
  background: var(--density-accent, var(--node-accent));
  z-index: 1;
  pointer-events: none;
  border-radius: 2px 0 0 0;
}

.density--dense::after {
  content: '';
  position: absolute;
  top: -1px;
  left: -1px;
  width: 3px;
  height: 48px;
  background: var(--density-accent, var(--node-accent));
  z-index: 1;
  pointer-events: none;
  border-radius: 2px 0 0 0;
}

/* Dense tier at far/ultra-far zoom: slightly increased node opacity for visual weight */
.note-node--lod-ultra-far.density--dense,
.note-node--lod-far.density--dense {
  opacity: 1;
}

/* Selection state: density pseudo-elements render behind selection highlight */
.cognograph-node.selected.density--substantial::before,
.cognograph-node.selected.density--substantial::after,
.cognograph-node.selected.density--dense::before,
.cognograph-node.selected.density--dense::after {
  z-index: 0;
}

/* Density transitions (respects reduced motion) */
.density--sparse,
.density--has-content,
.density--medium {
  transition: border-color 200ms ease-out, border-width 200ms ease-out;
}

.density--substantial::before,
.density--substantial::after,
.density--dense::before,
.density--dense::after {
  transition: width 200ms ease-out, height 200ms ease-out, background 200ms ease-out;
}

@media (prefers-reduced-motion: reduce) {
  .density--sparse,
  .density--has-content,
  .density--medium {
    transition: none;
  }

  .density--substantial::before,
  .density--substantial::after,
  .density--dense::before,
  .density--dense::after {
    transition: none;
  }
}

/* =============================================================================
   PFD PHASE 4: CONTEXT VISUALIZATION
   When context viz is active, dim non-included nodes and highlight included ones.
   Luminance-based depth encoding — no hue (reserved for NoteMode type).
   ============================================================================= */

/* Dim ALL nodes when context viz is active */
.context-viz-active .react-flow__node {
  opacity: 0.3;
  transition: opacity 300ms ease, filter 300ms ease;
}

/* Target node — full brightness */
.context-viz-active .react-flow__node.context-viz-target {
  opacity: 1;
  filter: brightness(1.15);
}

/* Included nodes — brightness by depth */
.context-viz-active .react-flow__node.context-viz-included {
  opacity: 1;
  filter: brightness(1.1);
}

.context-viz-active .react-flow__node.context-viz-depth-2 {
  opacity: 0.9;
  filter: brightness(1.0);
}

.context-viz-active .react-flow__node.context-viz-depth-3 {
  opacity: 0.75;
  filter: brightness(0.95);
}

/* Selected nodes always visible regardless of context viz */
.context-viz-active .react-flow__node.selected {
  opacity: 1;
  filter: none;
}

/* Dim ALL edges when context viz is active */
.context-viz-active .react-flow__edge {
  opacity: 0.15;
  transition: opacity 300ms ease;
}

/* Included edges — glow effect */
.context-viz-active .react-flow__edge.context-edge-included {
  opacity: 1;
}

.context-viz-active .react-flow__edge.context-edge-included path.react-flow__edge-path {
  stroke-width: 3;
  filter: drop-shadow(0 0 4px rgba(255, 255, 255, 0.3));
}

/* Selected edges always visible */
.context-viz-active .react-flow__edge.selected {
  opacity: 1;
}

/* =============================================================================
   CONTEXT SCOPE BADGE
   ============================================================================= */

.context-scope-badge {
  position: fixed;
  bottom: 16px;
  left: 50%;
  transform: translateX(-50%);
  z-index: 100;
  background: var(--gui-surface, rgba(30, 30, 30, 0.95));
  border: 1px solid var(--gui-border, rgba(255, 255, 255, 0.1));
  border-radius: 8px;
  padding: 6px 14px;
  font-size: 12px;
  color: var(--gui-text-secondary, rgba(255, 255, 255, 0.7));
  backdrop-filter: blur(8px);
  pointer-events: auto;
  cursor: default;
  user-select: none;
}

.context-scope-badge__count strong {
  color: var(--gui-text-primary, rgba(255, 255, 255, 0.95));
  font-weight: 600;
}

.context-scope-badge__detail {
  margin-top: 8px;
  padding-top: 8px;
  border-top: 1px solid var(--gui-border, rgba(255, 255, 255, 0.08));
  display: flex;
  gap: 16px;
  min-width: 200px;
}

.context-scope-badge__section {
  flex: 1;
}

.context-scope-badge__label {
  display: block;
  font-size: 10px;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  color: var(--gui-text-tertiary, rgba(255, 255, 255, 0.4));
  margin-bottom: 4px;
}

.context-scope-badge__row {
  display: flex;
  justify-content: space-between;
  gap: 12px;
  font-size: 11px;
  line-height: 1.6;
}

/* =============================================================================
   PFD PHASE 4B: CONTEXT ROLE LABELS
   Small role badges visible only during context visualization.
   ============================================================================= */

.context-role-badge {
  display: none;
  position: absolute;
  top: -18px;
  right: 8px;
  font-size: 9px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.06em;
  padding: 1px 6px;
  border-radius: 3px;
  z-index: 10;
  pointer-events: none;
  white-space: nowrap;
  background: rgba(40, 40, 40, 0.9);
  color: rgba(255, 255, 255, 0.7);
  border: 1px solid rgba(255, 255, 255, 0.1);
}

/* Show only when context viz is active AND node is included */
.context-viz-active .react-flow__node.context-viz-included .context-role-badge,
.context-viz-active .react-flow__node.context-viz-target .context-role-badge {
  display: block;
}

/* Role-specific accent colors (subtle left border) */
.context-role-badge[data-role="instruction"] {
  border-left: 2px solid #8b5cf6;
  color: #c4b5fd;
}

.context-role-badge[data-role="reference"] {
  border-left: 2px solid #3b82f6;
  color: #93c5fd;
}

.context-role-badge[data-role="example"] {
  border-left: 2px solid #f59e0b;
  color: #fcd34d;
}

.context-role-badge[data-role="background"] {
  border-left: 2px solid #6b7280;
  color: #9ca3af;
}

.context-role-badge[data-role="scope"] {
  border-left: 2px solid #10b981;
  color: #6ee7b7;
}

/* =============================================================================
   PFD PHASE 5B: HOVER PREVIEW (QUICK-LOOK)
   Tooltip-like preview of node content on hover.
   ============================================================================= */

.node-hover-preview {
  position: fixed;
  z-index: 1000;
  max-width: 320px;
  min-width: 180px;
  background: var(--gui-surface, rgba(28, 28, 28, 0.97));
  border: 1px solid var(--gui-border, rgba(255, 255, 255, 0.12));
  border-radius: 8px;
  padding: 10px 12px;
  pointer-events: none;
  backdrop-filter: blur(12px);
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
}

.node-hover-preview__title {
  font-size: 12px;
  font-weight: 600;
  color: var(--gui-text-primary, rgba(255, 255, 255, 0.9));
  margin-bottom: 4px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.node-hover-preview__meta {
  font-size: 10px;
  color: var(--gui-text-tertiary, rgba(255, 255, 255, 0.4));
  margin-bottom: 6px;
  text-transform: uppercase;
  letter-spacing: 0.04em;
}

.node-hover-preview__content {
  font-size: 11px;
  line-height: 1.5;
  color: var(--gui-text-secondary, rgba(255, 255, 255, 0.65));
  overflow: hidden;
  display: -webkit-box;
  -webkit-line-clamp: 4;
  -webkit-box-orient: vertical;
  max-height: 66px;
}

.node-hover-preview__empty {
  font-size: 11px;
  color: var(--gui-text-tertiary, rgba(255, 255, 255, 0.3));
  font-style: italic;
}

/* =============================================================================
   PFD PHASE 5A: IN-PLACE EXPANSION
   ============================================================================= */

/* Expanded node gets flexbox layout for scrollable body */
.cognograph-node--in-place-expanded {
  display: flex;
  flex-direction: column;
  z-index: 10;
  box-shadow: 0 0 0 3px var(--ring-color, #f59e0b), 0 8px 32px rgba(0, 0, 0, 0.4) !important;
}

/* Body takes remaining flex space and scrolls */
.cognograph-node__body--expanded {
  flex: 1;
  overflow: auto;
  overscroll-behavior: contain;
  min-height: 0; /* Required for flex scroll */
}

/* Collapse trigger button */
.cognograph-node__collapse-trigger {
  cursor: pointer;
  background: var(--salt-a3, rgba(128,128,128,0.08));
  border: 1px solid var(--salt-a5, rgba(128,128,128,0.15));
  color: var(--salt-11, #888);
  font-size: 0.75rem;
  padding: 4px 8px;
  border-radius: 4px;
  text-align: center;
  width: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 4px;
  transition: background-color 150ms ease, color 150ms ease;
}

.cognograph-node__collapse-trigger:hover {
  background-color: var(--salt-a5, rgba(128,128,128,0.15));
  color: var(--salt-12, #fff);
}

/* Dim non-expanded nodes when expansion is active */
.in-place-expansion-active .react-flow__node {
  opacity: 0.3;
  transition: opacity 200ms ease-out;
}

.in-place-expansion-active .react-flow__node.cognograph-node--in-place-expanded,
.in-place-expansion-active .react-flow__node:has(.cognograph-node--in-place-expanded) {
  opacity: 1;
}

/* Dim edges when expansion is active */
.in-place-expansion-active .react-flow__edge {
  opacity: 0.15;
  transition: opacity 200ms ease-out;
}

@media (prefers-reduced-motion: reduce) {
  .in-place-expansion-active .react-flow__node,
  .in-place-expansion-active .react-flow__edge {
    transition: none;
  }
}

@media (prefers-reduced-motion: reduce) {
  .context-viz-active .react-flow__node,
  .context-viz-active .react-flow__edge {
    transition: none;
  }
}

/* =============================================================================
   PFD PHASE 7A: CANVAS TABLE OF CONTENTS
   ============================================================================= */

.canvas-toc {
  position: fixed;
  top: 72px;
  right: 16px;
  width: 320px;
  max-height: calc(100vh - 100px);
  z-index: 50;
  display: flex;
  flex-direction: column;
  background: var(--gui-panel-bg, rgba(30, 30, 30, 0.95));
  border: 1px solid var(--gui-border, rgba(255, 255, 255, 0.1));
  border-radius: 8px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
  backdrop-filter: blur(12px);
  animation: toc-slide-in 200ms ease-out;
}

@keyframes toc-slide-in {
  from { opacity: 0; transform: translateX(8px); }
  to { opacity: 1; transform: translateX(0); }
}

.canvas-toc__header {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 12px;
  border-bottom: 1px solid var(--gui-border, rgba(255, 255, 255, 0.1));
}

.canvas-toc__title {
  font-size: 0.8rem;
  font-weight: 600;
  color: var(--gui-text-primary, #eee);
}

.canvas-toc__count {
  font-size: 0.7rem;
  color: var(--gui-text-tertiary, #666);
  margin-left: auto;
}

.canvas-toc__close {
  cursor: pointer;
  background: none;
  border: none;
  color: var(--gui-text-tertiary, #666);
  padding: 2px;
  border-radius: 4px;
  transition: color 150ms;
}

.canvas-toc__close:hover {
  color: var(--gui-text-primary, #eee);
}

.canvas-toc__controls {
  padding: 8px 12px;
  display: flex;
  flex-direction: column;
  gap: 6px;
  border-bottom: 1px solid var(--gui-border, rgba(255, 255, 255, 0.06));
}

.canvas-toc__search-wrap {
  position: relative;
  display: flex;
  align-items: center;
}

.canvas-toc__search-icon {
  position: absolute;
  left: 8px;
  color: var(--gui-text-tertiary, #666);
  pointer-events: none;
}

.canvas-toc__search {
  width: 100%;
  padding: 5px 8px 5px 28px;
  background: var(--gui-input-bg, rgba(255, 255, 255, 0.05));
  border: 1px solid var(--gui-border, rgba(255, 255, 255, 0.1));
  border-radius: 4px;
  color: var(--gui-text-primary, #eee);
  font-size: 0.8rem;
  outline: none;
}

.canvas-toc__search:focus {
  border-color: var(--gui-accent, #f59e0b);
}

.canvas-toc__filters {
  display: flex;
  gap: 6px;
}

.canvas-toc__sort-btn {
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 4px;
  background: var(--gui-input-bg, rgba(255, 255, 255, 0.05));
  border: 1px solid var(--gui-border, rgba(255, 255, 255, 0.1));
  border-radius: 4px;
  color: var(--gui-text-secondary, #aaa);
  font-size: 0.7rem;
  padding: 3px 8px;
  transition: background 150ms;
}

.canvas-toc__sort-btn:hover {
  background: var(--salt-a4, rgba(128, 128, 128, 0.1));
}

.canvas-toc__type-filter {
  background: var(--gui-input-bg, rgba(255, 255, 255, 0.05));
  border: 1px solid var(--gui-border, rgba(255, 255, 255, 0.1));
  border-radius: 4px;
  color: var(--gui-text-secondary, #aaa);
  font-size: 0.7rem;
  padding: 3px 6px;
  outline: none;
}

.canvas-toc__list {
  overflow-y: auto;
  overscroll-behavior: contain;
  flex: 1;
  min-height: 0;
  max-height: 400px;
}

.canvas-toc__item {
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 6px;
  width: 100%;
  padding: 6px 12px;
  background: none;
  border: none;
  border-bottom: 1px solid var(--gui-border, rgba(255, 255, 255, 0.04));
  color: var(--gui-text-primary, #eee);
  font-size: 0.8rem;
  text-align: left;
  transition: background 100ms;
}

.canvas-toc__item:hover {
  background: var(--salt-a3, rgba(128, 128, 128, 0.08));
}

.canvas-toc__item-type {
  font-size: 0.6rem;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  color: var(--gui-text-tertiary, #666);
  min-width: 48px;
}

.canvas-toc__item-title {
  flex: 1;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.canvas-toc__item-mode {
  font-size: 0.65rem;
  color: var(--gui-text-tertiary, #888);
  background: var(--salt-a3, rgba(128, 128, 128, 0.08));
  padding: 1px 4px;
  border-radius: 3px;
}

.canvas-toc__item-words {
  font-size: 0.65rem;
  color: var(--gui-text-tertiary, #555);
  min-width: 24px;
  text-align: right;
}

.canvas-toc__empty {
  padding: 20px 12px;
  text-align: center;
  color: var(--gui-text-tertiary, #666);
  font-size: 0.8rem;
}

@media (prefers-reduced-motion: reduce) {
  .canvas-toc {
    animation: none;
  }
}

/* Legacy canvas-level semantic zoom classes (kept for non-NoteNode types) */
.semantic-zoom-ultra-far .text-node-body {
  opacity: 0;
  pointer-events: none;
}

.semantic-zoom-far .text-node-body {
  opacity: 0.5;
  pointer-events: none;
}

.semantic-zoom-mid .text-node-body {
  opacity: 0.85;
}

/* Make first line slightly more prominent at mid-zoom for scanability */
.semantic-zoom-mid .text-node-body .tiptap > p:first-child,
.semantic-zoom-mid .text-node-body .tiptap > h1:first-child,
.semantic-zoom-mid .text-node-body .tiptap > h2:first-child,
.semantic-zoom-mid .text-node-body .tiptap > h3:first-child {
  font-weight: 500;
}

/* =============================================================================
   REDUCED MOTION SUPPORT
   Disable animations and transforms for users who prefer reduced motion
   ============================================================================= */

@media (prefers-reduced-motion: reduce) {
  .cognograph-node {
    transition: none;
  }

  .react-flow__node:not(.dragging) .cognograph-node:hover:not(.selected) {
    transform: none;
  }

  .react-flow__node.dragging .cognograph-node {
    transform: none;
  }

  .cognograph-node.node-collapsing,
  .cognograph-node.node-expanding {
    animation: none;
  }

  .react-flow__handle {
    transition: none;
  }

  .react-flow__handle.connecting {
    animation: none;
  }

  .react-flow__handle.connection-target-highlight {
    animation: none !important;
  }

  .react-flow__edgeupdater:hover circle {
    animation: none;
  }

  .cognograph-node.cognograph-node--celebrating {
    animation: none;
  }

  .numbered-bookmark-badge {
    transition: none;
  }

  .auto-fit-button,
  .fold-badge {
    transition: none;
  }
}

/* =============================================================================
   PFD PHASE 7B: CALM MODE
   Stimulus reduction toggle. Hides non-essential visual signals.
   Shows only: title, node outline, connections. Everything else fades.
   ============================================================================= */

.calm-mode-active .react-flow__node .cognograph-node__density-bar,
.calm-mode-active .react-flow__node .cognograph-node__tags,
.calm-mode-active .react-flow__node .cognograph-node__mode-badge,
.calm-mode-active .react-flow__node .cognograph-node__word-count,
.calm-mode-active .react-flow__node .cognograph-node__context-label,
.calm-mode-active .react-flow__node .numbered-bookmark-badge,
.calm-mode-active .react-flow__node .landmark-badge,
.calm-mode-active .react-flow__node .cognograph-node__body {
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s ease;
}

.calm-mode-active .react-flow__node {
  box-shadow: none !important;
  filter: none !important;
  border-color: var(--gui-border-subtle, rgba(255, 255, 255, 0.1)) !important;
}

.calm-mode-active .react-flow__node .cognograph-node__header {
  opacity: 0.85;
}

.calm-mode-active .react-flow__edge-path {
  opacity: 0.35 !important;
}

.calm-mode-active .canvas-district-overlay,
.calm-mode-active .spatial-region-overlay {
  opacity: 0;
  pointer-events: none;
}

.calm-mode-active .context-scope-badge,
.calm-mode-active .recency-fresh,
.calm-mode-active .recency-warm {
  box-shadow: none !important;
}

@media (prefers-reduced-motion: reduce) {
  .calm-mode-active .react-flow__node .cognograph-node__density-bar,
  .calm-mode-active .react-flow__node .cognograph-node__tags,
  .calm-mode-active .react-flow__node .cognograph-node__mode-badge,
  .calm-mode-active .react-flow__node .cognograph-node__word-count,
  .calm-mode-active .react-flow__node .cognograph-node__context-label,
  .calm-mode-active .react-flow__node .numbered-bookmark-badge,
  .calm-mode-active .react-flow__node .landmark-badge,
  .calm-mode-active .react-flow__node .cognograph-node__body {
    transition: none;
  }
}

/* =============================================================================
   PFD PHASE 7C: COGNITIVE LOAD METER
   Compact bar showing visible node count at overview zoom.
   ============================================================================= */

.cognitive-load-meter {
  position: fixed;
  bottom: 140px;
  left: 12px;
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 4px 8px;
  background: var(--gui-bg-secondary, rgba(17, 24, 39, 0.85));
  border: 1px solid var(--gui-border-subtle, rgba(255, 255, 255, 0.06));
  border-radius: 6px;
  backdrop-filter: blur(8px);
  z-index: 10;
  pointer-events: auto;
  user-select: none;
  animation: cognitive-load-fade-in 0.3s ease;
}

.cognitive-load-meter__bar {
  width: 40px;
  height: 4px;
  background: var(--gui-bg-tertiary, rgba(255, 255, 255, 0.05));
  border-radius: 2px;
  overflow: hidden;
}

.cognitive-load-meter__fill {
  height: 100%;
  border-radius: 2px;
  transition: width 0.5s ease, background-color 0.5s ease;
}

.cognitive-load-meter__label {
  font-size: 10px;
  font-weight: 600;
  letter-spacing: 0.02em;
}

@keyframes cognitive-load-fade-in {
  from { opacity: 0; transform: translateY(4px); }
  to { opacity: 1; transform: translateY(0); }
}

@media (prefers-reduced-motion: reduce) {
  .cognitive-load-meter {
    animation: none;
  }
  .cognitive-load-meter__fill {
    transition: none;
  }
}

/* =============================================================================
   EDGE GRAMMAR LEGEND
   Togglable legend showing edge visual encoding meaning.
   ============================================================================= */

.edge-grammar-legend {
  position: fixed;
  bottom: 60px;
  right: 12px;
  width: 240px;
  background: var(--gui-bg-secondary, rgba(17, 24, 39, 0.92));
  border: 1px solid var(--gui-border-subtle, rgba(255, 255, 255, 0.08));
  border-radius: 8px;
  backdrop-filter: blur(12px);
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
  z-index: 50;
  animation: edge-legend-slide-in 0.25s ease;
  overflow: hidden;
}

.edge-grammar-legend__header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 8px 12px;
  border-bottom: 1px solid var(--gui-border-subtle, rgba(255, 255, 255, 0.06));
}

.edge-grammar-legend__title {
  font-size: 0.75rem;
  font-weight: 600;
  color: var(--gui-text-primary, #e5e7eb);
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

.edge-grammar-legend__close {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 20px;
  height: 20px;
  border: none;
  background: transparent;
  color: var(--gui-text-muted, #6b7280);
  border-radius: 4px;
  cursor: pointer;
  transition: background 0.15s ease;
}

.edge-grammar-legend__close:hover {
  background: rgba(255, 255, 255, 0.08);
  color: var(--gui-text-primary, #e5e7eb);
}

.edge-grammar-legend__body {
  padding: 8px 12px 12px;
  max-height: 300px;
  overflow-y: auto;
}

.edge-grammar-legend__group {
  margin-bottom: 10px;
}

.edge-grammar-legend__group:last-child {
  margin-bottom: 0;
}

.edge-grammar-legend__group-title {
  font-size: 0.65rem;
  font-weight: 600;
  color: var(--gui-text-muted, #6b7280);
  text-transform: uppercase;
  letter-spacing: 0.06em;
  margin-bottom: 4px;
}

.edge-grammar-legend__item {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 3px 0;
}

.edge-grammar-legend__swatch {
  flex-shrink: 0;
}

.edge-grammar-legend__label {
  font-size: 0.72rem;
  font-weight: 500;
  color: var(--gui-text-primary, #e5e7eb);
  white-space: nowrap;
  min-width: 55px;
}

.edge-grammar-legend__desc {
  font-size: 0.65rem;
  color: var(--gui-text-muted, #6b7280);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

@keyframes edge-legend-slide-in {
  from { opacity: 0; transform: translateY(8px); }
  to { opacity: 1; transform: translateY(0); }
}

@media (prefers-reduced-motion: reduce) {
  .edge-grammar-legend {
    animation: none;
  }
}

/* =============================================================================
   EXECUTION STATUS BADGES — Phase 5A
   Shape-coded status indicators for orchestrated workflow nodes.
   WCAG 1.4.1: shapes differentiate status, not color alone.
   ============================================================================= */

.execution-status-badge {
  position: absolute;
  top: -6px;
  right: -6px;
  z-index: 110;
  display: flex;
  align-items: center;
  justify-content: center;
  pointer-events: auto;
  line-height: 0;
}

.execution-status-badge--active {
  animation: execution-pulse 1.5s ease-in-out infinite;
}

.execution-status-badge--queued {
  /* Static — no animation */
}

.execution-status-badge--complete {
  /* Static — no animation */
}

.execution-status-badge--error {
  /* Static — no animation */
}

@keyframes execution-pulse {
  0%, 100% {
    opacity: 1;
    transform: scale(1);
  }
  50% {
    opacity: 0.7;
    transform: scale(1.15);
  }
}

@media (prefers-reduced-motion: reduce) {
  .execution-status-badge--active {
    animation: none;
  }
}

/* =============================================================================
   PFD Phase 5B: Context Selection Ring
   ============================================================================= */

.context-selection-ring {
  outline: 2px dashed var(--gui-accent-primary, #3b82f6);
  outline-offset: 3px;
  animation: context-ring-dash 1.5s linear infinite;
  border-radius: 8px;
}

@keyframes context-ring-dash {
  0% {
    outline-offset: 3px;
    outline-color: var(--gui-accent-primary, #3b82f6);
  }
  50% {
    outline-offset: 5px;
    outline-color: var(--gui-accent-secondary, #8b5cf6);
  }
  100% {
    outline-offset: 3px;
    outline-color: var(--gui-accent-primary, #3b82f6);
  }
}

@media (prefers-reduced-motion: reduce) {
  .context-selection-ring {
    animation: none;
    outline: 2px dashed var(--gui-accent-primary, #3b82f6);
    outline-offset: 3px;
  }
}

/* =============================================================================
   ARTBOARD MODE — Phase 3A
   ============================================================================= */

.node-artboard {
  display: flex;
  flex-direction: column;
  border-radius: 12px;
  overflow: hidden;
  background: var(--surface-panel, #1a1a2e);
  border: 2px solid var(--node-accent, #6366f1);
  box-shadow: 0 0 20px color-mix(in srgb, var(--node-accent, #6366f1) 20%, transparent);
}

.node-artboard__header {
  display: flex;
  align-items: center;
  gap: 8px;
  height: 32px;
  padding: 0 12px;
  border-bottom: 1px solid color-mix(in srgb, var(--node-accent) 30%, transparent);
  font-size: 13px;
  font-weight: 500;
  color: var(--text-primary, #e5e5e5);
  flex-shrink: 0;
}

.node-artboard__header-icon {
  width: 16px;
  height: 16px;
  color: var(--node-accent);
  flex-shrink: 0;
}

.node-artboard__header-title {
  flex: 1;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.node-artboard__header-close {
  width: 24px;
  height: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
  border: none;
  background: transparent;
  color: var(--text-secondary, #999);
  cursor: pointer;
  border-radius: 4px;
  flex-shrink: 0;
}

.node-artboard__header-close:hover {
  background: rgba(255, 255, 255, 0.1);
  color: var(--text-primary);
}

.node-artboard__body {
  flex: 1;
  overflow: auto;
  min-height: 0;
}

/* Tab bar */
.artboard-tab-bar {
  display: flex;
  align-items: center;
  gap: 0;
  height: 36px;
  padding: 0 8px;
  border-bottom: 1px solid rgba(255, 255, 255, 0.08);
  flex-shrink: 0;
  overflow-x: auto;
}

.artboard-tab {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 6px 12px;
  font-size: 12px;
  color: var(--text-secondary, #999);
  cursor: pointer;
  border: none;
  background: transparent;
  border-bottom: 2px solid transparent;
  transition: color 150ms, border-color 150ms;
  white-space: nowrap;
}

.artboard-tab:hover {
  color: var(--text-primary);
}

.artboard-tab--active {
  color: var(--node-accent);
  border-bottom-color: var(--node-accent);
}

/* Split pane */
.artboard-split-pane {
  display: flex;
  flex: 1;
  min-height: 0;
  overflow: hidden;
}

.artboard-split-pane__left,
.artboard-split-pane__right {
  overflow: auto;
  min-width: 0;
}

.artboard-split-pane__divider {
  width: 4px;
  cursor: col-resize;
  background: rgba(255, 255, 255, 0.06);
  flex-shrink: 0;
  transition: background 150ms;
}

.artboard-split-pane__divider:hover,
.artboard-split-pane__divider:active {
  background: rgba(255, 255, 255, 0.15);
}

@media (prefers-reduced-motion: reduce) {
  .artboard-tab,
  .artboard-split-pane__divider {
    transition: none;
  }
}

/* =============================================================================
   CC SESSION VISUAL IDENTITY — Phase 4E
   Terminal session nodes with accent colors and status indicators
   ============================================================================= */

.conversation-node--cc-session {
  background: color-mix(in srgb, var(--surface-panel, #1a1a2e) 95%, #000 5%);
}

.cc-session-badge {
  font-family: 'JetBrains Mono', 'Fira Code', monospace;
  font-size: 9px;
  font-weight: 700;
  padding: 1px 3px;
  border-radius: 3px;
  background: rgba(0, 0, 0, 0.3);
  flex-shrink: 0;
}

/* Session status indicator animations */
.session-status--running {
  animation: session-pulse 2s ease-in-out infinite;
}

@keyframes session-pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}

@media (prefers-reduced-motion: reduce) {
  .session-status--running {
    animation: none;
  }
}


/* =============================================================================
   DEPTH-OF-FIELD RINGS -- Phase 6A
   Visual focal gradient based on BFS graph distance from a focus node.
   Ring 0 = focus node (no change), Ring 1-3 = increasing dimming,
   Out-of-scope = disconnected nodes (near-invisible).
   ============================================================================= */

.dof-ring-0 {
  /* Focus node -- no visual modification */
}

.dof-ring-1 {
  opacity: 0.85;
  filter: saturate(0.9);
  transition: opacity 200ms ease, filter 200ms ease;
}

.dof-ring-2 {
  opacity: 0.65;
  filter: saturate(0.7) brightness(0.95);
  transition: opacity 200ms ease, filter 200ms ease;
}

.dof-ring-3 {
  opacity: 0.5;
  filter: saturate(0.5) brightness(0.9);
  transition: opacity 200ms ease, filter 200ms ease;
}

.dof-out-of-scope {
  opacity: 0.25;
  filter: saturate(0.3) brightness(0.85) blur(0.5px);
  transition: opacity 200ms ease, filter 200ms ease;
}

/*
 * Minimum opacity floor: nodes with visible text content (mid, close, ultra-close)
 * should never go below 0.4 opacity even when out of DoF scope.
 * Nodes at far/ultra-far LOD can go down to 0.25.
 */
[data-lod="mid"].dof-out-of-scope,
[data-lod="close"].dof-out-of-scope,
[data-lod="ultra-close"].dof-out-of-scope {
  opacity: 0.4;
}

[data-lod="mid"].dof-ring-3,
[data-lod="close"].dof-ring-3,
[data-lod="ultra-close"].dof-ring-3 {
  opacity: 0.5;
}

/* DoF reduced-motion: instant opacity, no filter transitions */
@media (prefers-reduced-motion: reduce) {
  .dof-ring-1,
  .dof-ring-2,
  .dof-ring-3,
  .dof-out-of-scope {
    transition: none;
  }
}

/* =============================================================================
   CALM MODE LEVELS — Phase 6F
   Stepped calm mode slider: 4 levels of progressive visual reduction.
   Applied via data-calm attribute on the canvas container.
   Level 0: Normal (no attribute needed)
   Level 1: Subtle desaturation
   Level 2: More desaturation + dimming, suppress animations
   Level 3: Maximum reduction, text-only mode
   ============================================================================= */

[data-calm="1"] {
  filter: saturate(0.85);
}

[data-calm="2"] {
  filter: saturate(0.7) brightness(0.95);
}

[data-calm="2"] *,
[data-calm="2"] *::before,
[data-calm="2"] *::after {
  animation-duration: 0.01ms !important;
  transition-duration: 0.01ms !important;
}

[data-calm="3"] {
  filter: saturate(0.5) brightness(0.9);
}

[data-calm="3"] *,
[data-calm="3"] *::before,
[data-calm="3"] *::after {
  animation-duration: 0.01ms !important;
  transition-duration: 0.01ms !important;
}

/* Calm mode indicator pill */
.calm-mode-indicator {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 2px 8px;
  font-size: 11px;
  font-weight: 600;
  border-radius: 9999px;
  background: color-mix(in srgb, var(--surface-panel, #1a1a2e) 90%, transparent);
  color: var(--text-secondary, #999);
  border: 1px solid rgba(255, 255, 255, 0.08);
  pointer-events: none;
  user-select: none;
  transition: opacity 200ms ease, background 200ms ease;
}

.calm-mode-indicator[data-level="0"] {
  opacity: 0;
}

.calm-mode-indicator[data-level="1"] {
  opacity: 0.7;
  color: var(--gui-accent-success, #10b981);
}

.calm-mode-indicator[data-level="2"] {
  opacity: 0.85;
  color: var(--gui-accent-warning, #f59e0b);
}

.calm-mode-indicator[data-level="3"] {
  opacity: 1;
  color: var(--gui-accent-danger, #ef4444);
}


/* =============================================================================
   PFD PHASE 6B: CLUSTER OVERLAY
   Summary bubbles rendered at L0 (ultra-far) zoom showing spatial clusters.
   ============================================================================= */

.cluster-overlay {
  position: fixed;
  inset: 0;
  pointer-events: none;
  z-index: 10;
}

.cluster-bubble {
  pointer-events: auto;
  cursor: pointer;
  border-radius: 50%;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 2px;
  backdrop-filter: blur(4px);
  transition: transform 150ms ease-out, box-shadow 150ms ease-out;
}

.cluster-bubble:hover {
  transform: scale(1.1);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}

.cluster-bubble-icon {
  opacity: 0.8;
}

.cluster-bubble-count {
  font-size: 11px;
  font-weight: 700;
  color: var(--text-primary, #e2e8f0);
  line-height: 1;
}

.cluster-bubble-status {
  font-size: 8px;
  color: var(--text-secondary, #94a3b8);
  line-height: 1;
  white-space: nowrap;
}

@media (prefers-reduced-motion: reduce) {
  .cluster-bubble {
    transition: none;
  }
}

/* =============================================================================
   Global Reduced Motion (Phase 1B)
   Kills ALL animations and transitions for users who prefer reduced motion.
   Individual @media (prefers-reduced-motion) blocks above handle specific cases;
   this is the nuclear option that catches everything else.
   ============================================================================= */

@media (prefers-reduced-motion: reduce) {
  *,
  *::before,
  *::after {
    animation-duration: 0.01ms !important;
    transition-duration: 0.01ms !important;
  }
}
